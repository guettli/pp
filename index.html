<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phoneme Party - Pronunciation Practice</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéâ</text></svg>"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Shantell+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Console interceptor to show all console output in UI -->
    <script type="module">
      import { onLanguageChange, t } from "/src/i18n.ts";

      (function () {
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalInfo = console.info;
        const originalFetch = window.fetch;

        function addToConsoleOutput(type, args) {
          const timestamp = new Date().toLocaleTimeString();
          const message = Array.from(args)
            .map((arg) => {
              if (typeof arg === "object") {
                try {
                  return JSON.stringify(arg, null, 2);
                } catch (e) {
                  return String(arg);
                }
              }
              return String(arg);
            })
            .join(" ");

          const consoleOutput = document.getElementById("console-output");
          if (consoleOutput) {
            const prefix =
              type === "error" ? "‚ùå " : type === "warn" ? "‚ö†Ô∏è " : type === "info" ? "‚ÑπÔ∏è " : "‚ñ∂Ô∏è ";
            consoleOutput.textContent += `${timestamp} ${prefix}${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
          }
        }

        console.log = function (...args) {
          originalLog.apply(console, args);
          addToConsoleOutput("log", args);
        };

        console.error = function (...args) {
          originalError.apply(console, args);
          addToConsoleOutput("error", args);
        };

        console.warn = function (...args) {
          originalWarn.apply(console, args);
          addToConsoleOutput("warn", args);
        };

        console.info = function (...args) {
          originalInfo.apply(console, args);
          addToConsoleOutput("info", args);
        };

        // Fetch interceptor to log all HTTP requests and responses
        const requestMap = new Map();
        window.fetch = async function (...args) {
          const url = typeof args[0] === "string" ? args[0] : args[0]?.url || "unknown";
          const requestId = Date.now() + Math.random();
          const startTime = Date.now();

          requestMap.set(requestId, { url, startTime });

          console.log("üåê FETCH REQUEST:", url);
          console.log("   Request ID:", requestId);
          console.log("   Started at:", new Date().toLocaleTimeString());

          try {
            const response = await originalFetch.apply(this, args);
            const duration = Date.now() - startTime;

            // Clone the response so we can read it
            const clonedResponse = response.clone();
            const contentType = response.headers.get("content-type");
            const contentLength = response.headers.get("content-length");
            const cacheControl = response.headers.get("cache-control");

            console.log("üì• FETCH RESPONSE:", url);
            console.log("   Request ID:", requestId);
            console.log("   Status:", response.status, response.statusText);
            console.log("   Duration:", duration, "ms");
            console.log("   Content-Type:", contentType);
            console.log("   Content-Length:", contentLength, "bytes");
            console.log("   Cache-Control:", cacheControl);
            console.log("   From cache:", response.headers.get("x-cache") || "unknown");

            // Only read text for small responses or when content type suggests it
            if (
              (contentLength && parseInt(contentLength) < 100000) ||
              contentType?.includes("json") ||
              contentType?.includes("text") ||
              contentType?.includes("html")
            ) {
              try {
                const text = await clonedResponse.text();

                if (text.startsWith("<") || text.startsWith("<!DOCTYPE")) {
                  console.error("üö® CRITICAL: Expected JSON/binary but got HTML!");
                  console.error("   URL:", url);
                  console.error("   This usually means a 404 or server error");
                  console.error("   Full response:");
                  console.error(text);
                  console.error("   ");
                } else {
                  console.log("   ‚úÖ Response looks valid (not HTML)");
                  if (text.length < 500) {
                    console.log("   Content:", text);
                  } else {
                    console.log("   Preview (first 200 chars):", text.substring(0, 200));
                  }
                }
              } catch (e) {
                console.log("   (Could not read response body:", e.message, ")");
              }
            } else {
              console.log("   ‚úÖ Binary/large file, not reading body");
            }

            requestMap.delete(requestId);
            return response;
          } catch (error) {
            const duration = Date.now() - startTime;
            console.error("‚ùå FETCH ERROR:", url);
            console.error("   Request ID:", requestId);
            console.error("   Duration:", duration, "ms");
            console.error("   Error:", error.message);
            requestMap.delete(requestId);
            throw error;
          }
        };

        // Log pending requests periodically
        setInterval(() => {
          if (requestMap.size > 0) {
            console.log("üìä Pending requests:", requestMap.size);
            for (const [id, req] of requestMap.entries()) {
              const elapsed = Date.now() - req.startTime;
              console.log(`   - ${req.url} (${elapsed}ms elapsed)`);
            }
          }
        }, 10000); // Every 10 seconds

        // Add clear button functionality
        document.addEventListener("DOMContentLoaded", function () {
          const clearBtn = document.getElementById("clear-console");
          const copyBtn = document.getElementById("copy-console");
          const consoleOutput = document.getElementById("console-output");
          const consoleCollapse = document.getElementById("console-body-collapse");
          const consoleChevron = document.getElementById("console-chevron");

          if (clearBtn && consoleOutput) {
            clearBtn.addEventListener("click", function () {
              consoleOutput.textContent = "";
            });
          }

          if (copyBtn && consoleOutput) {
            copyBtn.addEventListener("click", async function () {
              const text = consoleOutput.textContent;
              try {
                await navigator.clipboard.writeText(text);
                // Visual feedback
                const originalText = copyBtn.textContent;
                copyBtn.textContent = t("console.copy_success");
                setTimeout(() => {
                  copyBtn.textContent = originalText;
                }, 2000);
              } catch (err) {
                console.error("Failed to copy:", err);
                copyBtn.textContent = t("console.copy_failed");
                setTimeout(() => {
                  copyBtn.textContent = t("console.copy");
                }, 2000);
              }
            });
          }

          // Toggle chevron icon when console is expanded/collapsed
          if (consoleCollapse && consoleChevron) {
            consoleCollapse.addEventListener("shown.bs.collapse", function () {
              consoleChevron.classList.remove("bi-chevron-down");
              consoleChevron.classList.add("bi-chevron-up");
            });

            consoleCollapse.addEventListener("hidden.bs.collapse", function () {
              consoleChevron.classList.remove("bi-chevron-up");
              consoleChevron.classList.add("bi-chevron-down");
            });
          }

          onLanguageChange(() => {
            if (copyBtn) {
              copyBtn.textContent = t("console.copy");
            }
          });
        });
      })();
    </script>

    <!-- Load ONNX Runtime Web for phoneme model -->
    <script
      src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.0/dist/ort.min.js"
      crossorigin="anonymous"
    ></script>
    <script>
      // Configure ONNX Runtime
      if (window.ort) {
        // Multi-threading requires crossOriginIsolated (SharedArrayBuffer)
        if (crossOriginIsolated) {
          ort.env.wasm.numThreads = navigator.hardwareConcurrency || 4;
          console.log(
            "ONNX Runtime Web loaded with",
            ort.env.wasm.numThreads,
            "threads (crossOriginIsolated)",
          );
        } else {
          ort.env.wasm.numThreads = 1;
          console.log(
            "ONNX Runtime Web loaded (single-threaded, crossOriginIsolated not available)",
          );
        }
      }
    </script>
  </head>

  <body>
    <div id="app" class="container py-5">
      <!-- Header -->
      <header class="text-center mb-5">
        <h1 class="display-4 fw-bold" data-i18n="header.title">Phoneme Party</h1>
        <p class="lead text-muted" data-i18n="header.subtitle">
          Practice German pronunciation with AI
        </p>
        <div class="d-flex justify-content-center align-items-center gap-2 mt-3">
          <label for="language-select" class="form-label mb-0" data-i18n="language.label"
            >Language:</label
          >
          <select id="language-select" class="form-select form-select-sm w-auto">
            <option value="de" data-i18n="language.de">German</option>
            <option value="en" data-i18n="language.en">English</option>
          </select>
        </div>
      </header>

      <!-- Loading Overlay -->
      <div id="loading-overlay" class="card shadow-sm mb-4">
        <div class="card-body text-center py-5">
          <div class="mb-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden" data-i18n="loading.hidden_label">Loading...</span>
            </div>
          </div>
          <h5 id="loading-status" class="mb-3" data-i18n="loading.initializing">Initializing...</h5>
          <div class="progress" style="height: 25px">
            <div
              id="loading-progress"
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              style="width: 0%"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
            >
              0%
            </div>
          </div>
          <p class="text-muted mt-3 small" data-i18n="loading.description">
            Downloading multilingual AI model (~150MB). This may take a moment on first load.
          </p>
        </div>
      </div>

      <!-- Main Content (hidden until loaded) -->
      <div id="main-content" style="display: none">
        <!-- Phrase Display Card -->
        <div class="card shadow-lg mb-4">
          <div class="card-body text-center py-5">
            <div id="phrase-emoji" class="emoji-display mb-3">üê±</div>
            <div class="d-flex justify-content-center align-items-center gap-2">
              <h2 id="phrase-text" class="display-5 fw-bold mb-0" style="cursor: pointer">Katze</h2>
              <button
                id="replay-phrase-btn"
                class="btn btn-sm btn-outline-secondary"
                title="Play phrase again"
              >
                <i class="bi bi-volume-up-fill"></i>
              </button>
            </div>
            <p id="phrase-ipa" class="text-muted fs-5 mb-0" style="display: none">/ÀàkatÕ°s…ô/</p>
          </div>
        </div>

        <!-- Controls -->
        <div class="d-flex gap-3 mb-3">
          <button id="record-btn" class="btn btn-lg btn-danger flex-grow-1" disabled>
            <span id="record-icon">üé§</span>
            <span id="record-text" data-i18n="record.hold">Hold to Record</span>
          </button>
          <button id="next-phrase-btn" class="btn btn-lg btn-outline-primary flex-grow-1">
            <span data-i18n="buttons.next_phrase">Next Phrase ‚Üí</span>
          </button>
        </div>

        <!-- Processing Progress Bar -->
        <div class="mb-4">
          <div id="processing-progress" class="progress" style="display: none; height: 30px">
            <div
              id="processing-progress-bar"
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              style="width: 0%"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
            >
              <span data-i18n="processing.label">Processing...</span>
            </div>
          </div>
        </div>

        <!-- Feedback Section (hidden initially) -->
        <div id="feedback-section" style="display: none">
          <div class="card shadow-sm">
            <div class="card-header">
              <h5 class="mb-0" data-i18n="feedback.title">Your Pronunciation</h5>
            </div>
            <div class="card-body">
              <div id="feedback-alert" class="alert mb-3" role="alert">
                <!-- Dynamic content will be inserted here -->
              </div>

              <div class="text-center mb-3">
                <strong data-i18n="feedback.target_phrase_label">Target Phrase:</strong>
                <p id="feedback-target" class="mb-0"></p>
              </div>

              <!-- Side-by-side phoneme comparison -->
              <div id="phoneme-comparison" class="mb-3">
                <div class="d-flex justify-content-center align-items-start gap-2 flex-wrap">
                  <div class="d-flex align-items-center">
                    <strong class="me-2" data-i18n="feedback.target_ipa_label">Target IPA:</strong>
                    <button
                      id="play-target-btn"
                      class="btn btn-sm btn-outline-secondary"
                      data-i18n-attr="title:feedback.play_target"
                      title="Play desired pronunciation"
                      style="display: none"
                    >
                      <i class="bi bi-volume-up-fill"></i>
                    </button>
                    <small
                      id="speech-synthesis-hint"
                      class="text-muted ms-2"
                      style="display: none"
                    ></small>
                  </div>
                  <div class="d-flex align-items-center">
                    <strong class="me-2" data-i18n="feedback.your_ipa_label">Your IPA:</strong>
                    <button
                      id="play-recording-btn"
                      class="btn btn-sm btn-outline-secondary"
                      title="Play your recording"
                      style="display: none"
                    >
                      <i class="bi bi-play-fill"></i>
                    </button>
                  </div>
                </div>
                <div
                  id="phoneme-comparison-grid"
                  class="mt-3 d-flex justify-content-center flex-wrap gap-1"
                >
                  <!-- Dynamic phoneme comparison will be inserted here -->
                </div>
                <!-- Hidden elements for IPA helper -->
                <span id="feedback-target-ipa" style="display: none"></span>
                <span id="feedback-actual-ipa" style="display: none"></span>
              </div>

              <!-- IPA Explanations (collapsible) -->
              <div class="mt-3">
                <a
                  id="ipa-help-toggle"
                  class="text-decoration-none small"
                  href="#"
                  role="button"
                  aria-expanded="false"
                >
                  <i class="bi bi-info-circle me-1"></i>
                  <span data-i18n="feedback.ipa_help">What do these symbols mean?</span>
                  <i id="ipa-help-chevron" class="bi bi-chevron-down ms-1"></i>
                </a>
                <div id="ipa-explanations" class="mt-2" style="display: none">
                  <div class="card card-body bg-light small" id="ipa-explanations-content">
                    <!-- Dynamic content will be inserted here -->
                  </div>
                </div>
              </div>

              <div class="text-center mt-4">
                <h4 id="feedback-score" class="mb-3"></h4>
                <p id="feedback-message" class="lead"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- History Section -->
        <div class="card shadow-sm mt-4">
          <div class="card-header">
            <h5 class="mb-0" data-i18n="history.title">Training History</h5>
          </div>
          <div class="card-body">
            <div id="history-container" style="max-height: 500px; overflow-y: auto">
              <div id="history-list">
                <!-- History items will be dynamically inserted here -->
              </div>
              <div id="history-loading" class="text-center py-3" style="display: none">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2 small text-muted" data-i18n="history.loading"
                  >Loading more...</span
                >
              </div>
              <div id="history-empty" class="text-center py-4 text-muted" style="display: none">
                <i class="bi bi-inbox fs-1"></i>
                <p class="mt-2" data-i18n="history.empty">
                  No training history yet. Start practicing!
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Processing Debug (shown after processing) -->
        <div id="processing-debug" class="processing-debug mt-4" style="display: none"></div>
      </div>

      <!-- Console Output -->
      <div class="card mb-4 bg-dark text-light">
        <div
          class="card-header d-flex justify-content-between align-items-center"
          style="cursor: pointer"
          id="console-header"
          data-bs-toggle="collapse"
          data-bs-target="#console-body-collapse"
          aria-expanded="false"
          aria-controls="console-body-collapse"
        >
          <div>
            <strong data-i18n="console.title">Console Output</strong>
            <i id="console-chevron" class="bi bi-chevron-down ms-2"></i>
          </div>
          <div class="btn-group btn-group-sm">
            <button
              id="copy-console"
              class="btn btn-outline-light"
              data-i18n="console.copy"
              data-i18n-attr="title:console.copy_title"
              onclick="event.stopPropagation()"
            >
              Copy
            </button>
            <button
              id="clear-console"
              class="btn btn-outline-light"
              data-i18n="console.clear"
              data-i18n-attr="title:console.clear_title"
              onclick="event.stopPropagation()"
            >
              Clear
            </button>
          </div>
        </div>
        <div id="console-body-collapse" class="collapse">
          <div class="card-body">
            <pre
              id="console-output"
              style="
                max-height: 300px;
                overflow-y: auto;
                margin: 0;
                font-size: 0.85rem;
                white-space: pre-wrap;
              "
            ></pre>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="text-center mt-5 text-muted">
        <small>
          <span data-i18n="footer.powered_by">Powered by</span>
          <a href="https://github.com/huggingface/transformers.js" target="_blank"
            >Transformers.js</a
          >
          |
          <span data-i18n="footer.local_processing"
            >All processing happens locally in your browser</span
          >
          |
          <span id="webgpu-status" data-i18n="footer.webgpu_status_checking"
            >WebGPU: checking...</span
          >
          |
          <a href="attribution.html" data-i18n="footer.attribution">Attribution</a>
        </small>
      </footer>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
